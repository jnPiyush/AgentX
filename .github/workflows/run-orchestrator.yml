# Manual Orchestrator - Debug, override, or recovery

name: Run Orchestrator

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
      command:
        description: 'Command (route, pause, resume, skip, retry)'
        type: choice
        options: [route, pause, resume, skip, retry]
        default: route
      target_agent:
        description: 'Target (for skip/route)'
        type: choice
        options: ['', product-manager, architect, ux-designer, engineer, reviewer]
        default: ''

permissions:
  issues: write
  contents: read
  actions: write

jobs:
  orchestrate:
    name: Execute Orchestrator
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Issue Details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Fetching issue #${{ inputs.issue_number }}"
          
          # Get issue details
          issue_json=$(gh issue view ${{ inputs.issue_number }} --json number,title,labels,body,state)
          
          # Extract labels
          labels=$(echo "$issue_json" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          echo "labels=$labels" >> $GITHUB_OUTPUT
          
          # Extract type
          type=$(echo "$issue_json" | jq -r '.labels[] | select(.name | startswith("type:")) | .name')
          echo "type=$type" >> $GITHUB_OUTPUT
          
          # Extract title
          title=$(echo "$issue_json" | jq -r '.title')
          echo "title=$title" >> $GITHUB_OUTPUT
          
          # Extract state
          state=$(echo "$issue_json" | jq -r '.state')
          echo "state=$state" >> $GITHUB_OUTPUT
          
          # Check orchestration labels
          has_pm_done=$(echo "$labels" | grep -q "orch:pm-done" && echo "true" || echo "false")
          has_architect_done=$(echo "$labels" | grep -q "orch:architect-done" && echo "true" || echo "false")
          has_ux_done=$(echo "$labels" | grep -q "orch:ux-done" && echo "true" || echo "false")
          has_engineer_done=$(echo "$labels" | grep -q "orch:engineer-done" && echo "true" || echo "false")
          
          echo "has_pm_done=$has_pm_done" >> $GITHUB_OUTPUT
          echo "has_architect_done=$has_architect_done" >> $GITHUB_OUTPUT
          echo "has_ux_done=$has_ux_done" >> $GITHUB_OUTPUT
          echo "has_engineer_done=$has_engineer_done" >> $GITHUB_OUTPUT
          
          echo "âœ… Issue details captured"
      
      - name: Execute Command
        if: inputs.command != 'route'
        run: |
          case "${{ inputs.command }}" in
            pause)
              gh issue edit ${{ inputs.issue_number }} --add-label "orchestration:paused"
              gh issue comment ${{ inputs.issue_number }} --body "â¸ï¸ **Paused**. Use \`/resume\` to continue."
              exit 0
              ;;
            resume)
              gh issue edit ${{ inputs.issue_number }} --remove-label "orchestration:paused"
              gh issue comment ${{ inputs.issue_number }} --body "â–¶ï¸ **Resumed**. Routing..."
              ;;
            skip)
              [ -z "${{ inputs.target_agent }}" ] && echo "Error: target_agent required" && exit 1
              gh issue comment ${{ inputs.issue_number }} --body "â­ï¸ **Skipped** ${{ inputs.target_agent }}"
              ;;
            retry)
              gh issue comment ${{ inputs.issue_number }} --body "ðŸ”„ **Retrying** current stage..."
              ;;
          esac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Route
        id: route
        run: |
          type="${{ steps.issue.outputs.type }}"
          pm="${{ steps.issue.outputs.has_pm_done }}"
          arch="${{ steps.issue.outputs.has_architect_done }}"
          ux="${{ steps.issue.outputs.has_ux_done }}"
          eng="${{ steps.issue.outputs.has_engineer_done }}"
          
          run_pm=false; run_architect=false; run_ux=false; run_engineer=false; run_reviewer=false
          
          case "$type" in
            type:epic)
              [ "$pm" = "false" ] && run_pm=true
              [ "$pm" = "true" ] && [ "$arch" = "false" ] && run_architect=true
              [ "$pm" = "true" ] && [ "$ux" = "false" ] && run_ux=true
              ;;
            type:feature|type:story)
              [ "$eng" = "false" ] && run_engineer=true || run_reviewer=true
              ;;
            type:bug|type:docs)
              [ "$eng" = "false" ] && run_engineer=true || run_reviewer=true
              ;;
            type:spike)
              [ "$arch" = "false" ] && run_architect=true
              ;;
          esac
          
          echo "run_pm=$run_pm" >> $GITHUB_OUTPUT
          echo "run_architect=$run_architect" >> $GITHUB_OUTPUT
          echo "run_ux=$run_ux" >> $GITHUB_OUTPUT
          echo "run_engineer=$run_engineer" >> $GITHUB_OUTPUT
          echo "run_reviewer=$run_reviewer" >> $GITHUB_OUTPUT
      
      - name: Trigger Workflows
        run: |
          issue="${{ inputs.issue_number }}"
          agents=()
          
          [ "${{ steps.route.outputs.run_pm }}" = "true" ] && gh workflow run run-product-manager.yml -f issue_number=$issue && agents+=("PM")
          [ "${{ steps.route.outputs.run_architect }}" = "true" ] && gh workflow run run-architect.yml -f issue_number=$issue && agents+=("Architect")
          [ "${{ steps.route.outputs.run_ux }}" = "true" ] && gh workflow run run-ux-designer.yml -f issue_number=$issue && agents+=("UX")
          [ "${{ steps.route.outputs.run_engineer }}" = "true" ] && gh workflow run run-engineer.yml -f issue_number=$issue && agents+=("Engineer")
          [ "${{ steps.route.outputs.run_reviewer }}" = "true" ] && gh workflow run run-reviewer.yml -f issue_number=$issue && agents+=("Reviewer")
          
          if [ ${#agents[@]} -eq 0 ]; then
            comment="ðŸ¤– **Orchestrator**: No routing needed"
          else
            comment="ðŸ¤– **Orchestrator**: Routed to ${agents[*]} | Command: \`${{ inputs.command }}\`"
          fi
          
          gh issue comment $issue --body "$comment"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Report Summary
        run: |
          echo "## Orchestration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ inputs.issue_number }} - ${{ steps.issue.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: ${{ steps.issue.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Command**: ${{ inputs.command }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agents Routed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Product Manager: ${{ steps.route.outputs.run_pm }}" >> $GITHUB_STEP_SUMMARY
          echo "- Architect: ${{ steps.route.outputs.run_architect }}" >> $GITHUB_STEP_SUMMARY
          echo "- UX Designer: ${{ steps.route.outputs.run_ux }}" >> $GITHUB_STEP_SUMMARY
          echo "- Engineer: ${{ steps.route.outputs.run_engineer }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reviewer: ${{ steps.route.outputs.run_reviewer }}" >> $GITHUB_STEP_SUMMARY
