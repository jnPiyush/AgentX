# Manual Orchestrator Invocation
# Allows manual triggering of the Orchestrator agent for debugging, overrides, or recovery

name: Run Orchestrator

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to orchestrate'
        required: true
        type: string
      command:
        description: 'Optional command: route, pause, resume, skip, retry'
        required: false
        type: choice
        options:
          - route
          - pause
          - resume
          - skip
          - retry
        default: 'route'
      target_agent:
        description: 'Target agent (for skip/route commands)'
        required: false
        type: choice
        options:
          - product-manager
          - architect
          - ux-designer
          - engineer
          - reviewer
        default: ''

permissions:
  issues: write
  contents: read
  actions: write

jobs:
  orchestrate:
    name: Execute Orchestrator
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get Issue Details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Fetching issue #${{ inputs.issue_number }}"
          
          # Get issue details
          issue_json=$(gh issue view ${{ inputs.issue_number }} --json number,title,labels,body,state)
          
          # Extract labels
          labels=$(echo "$issue_json" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          echo "labels=$labels" >> $GITHUB_OUTPUT
          
          # Extract type
          type=$(echo "$issue_json" | jq -r '.labels[] | select(.name | startswith("type:")) | .name')
          echo "type=$type" >> $GITHUB_OUTPUT
          
          # Extract title
          title=$(echo "$issue_json" | jq -r '.title')
          echo "title=$title" >> $GITHUB_OUTPUT
          
          # Extract state
          state=$(echo "$issue_json" | jq -r '.state')
          echo "state=$state" >> $GITHUB_OUTPUT
          
          # Check orchestration labels
          has_pm_done=$(echo "$labels" | grep -q "orch:pm-done" && echo "true" || echo "false")
          has_architect_done=$(echo "$labels" | grep -q "orch:architect-done" && echo "true" || echo "false")
          has_ux_done=$(echo "$labels" | grep -q "orch:ux-done" && echo "true" || echo "false")
          has_engineer_done=$(echo "$labels" | grep -q "orch:engineer-done" && echo "true" || echo "false")
          
          echo "has_pm_done=$has_pm_done" >> $GITHUB_OUTPUT
          echo "has_architect_done=$has_architect_done" >> $GITHUB_OUTPUT
          echo "has_ux_done=$has_ux_done" >> $GITHUB_OUTPUT
          echo "has_engineer_done=$has_engineer_done" >> $GITHUB_OUTPUT
          
          echo "âœ… Issue details captured"
      
      - name: Execute Command
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          command="${{ inputs.command }}"
          issue_number="${{ inputs.issue_number }}"
          
          case "$command" in
            route)
              echo "ðŸ”€ Executing: Route to next agent"
              ;;
            pause)
              echo "â¸ï¸ Executing: Pause workflow"
              gh issue edit $issue_number --add-label "orchestration:paused"
              gh issue comment $issue_number --body "â¸ï¸ **Orchestrator**: Workflow paused by manual command. Use \`/resume\` to continue."
              exit 0
              ;;
            resume)
              echo "â–¶ï¸ Executing: Resume workflow"
              gh issue edit $issue_number --remove-label "orchestration:paused"
              gh issue comment $issue_number --body "â–¶ï¸ **Orchestrator**: Workflow resumed. Determining next agent..."
              ;;
            skip)
              echo "â­ï¸ Executing: Skip stage"
              target="${{ inputs.target_agent }}"
              if [ -z "$target" ]; then
                echo "âŒ Error: target_agent required for skip command"
                exit 1
              fi
              gh issue comment $issue_number --body "â­ï¸ **Orchestrator**: Skipped $target stage by manual command."
              ;;
            retry)
              echo "ðŸ”„ Executing: Retry current stage"
              gh issue comment $issue_number --body "ðŸ”„ **Orchestrator**: Retrying current stage..."
              ;;
          esac
      
      - name: Determine Next Agent(s)
        id: route
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          type="${{ steps.issue.outputs.type }}"
          labels="${{ steps.issue.outputs.labels }}"
          issue_number="${{ inputs.issue_number }}"
          
          # Initialize agent flags
          run_pm="false"
          run_architect="false"
          run_ux="false"
          run_engineer="false"
          run_reviewer="false"
          
          echo "ðŸ“Š Current state:"
          echo "  Type: $type"
          echo "  PM Done: ${{ steps.issue.outputs.has_pm_done }}"
          echo "  Architect Done: ${{ steps.issue.outputs.has_architect_done }}"
          echo "  UX Done: ${{ steps.issue.outputs.has_ux_done }}"
          echo "  Engineer Done: ${{ steps.issue.outputs.has_engineer_done }}"
          
          # Routing logic based on state machine
          case "$type" in
            type:epic)
              if [ "${{ steps.issue.outputs.has_pm_done }}" == "false" ]; then
                run_pm="true"
                echo "â†’ Route to: Product Manager (PRD creation)"
              fi
              if [ "${{ steps.issue.outputs.has_pm_done }}" == "true" ] && [ "${{ steps.issue.outputs.has_architect_done }}" == "false" ]; then
                run_architect="true"
                echo "â†’ Route to: Architect (ADR + Specs)"
              fi
              if [ "${{ steps.issue.outputs.has_pm_done }}" == "true" ] && [ "${{ steps.issue.outputs.has_ux_done }}" == "false" ]; then
                run_ux="true"
                echo "â†’ Route to: UX Designer (Wireframes)"
              fi
              ;;
            
            type:feature|type:story)
              if [ "${{ steps.issue.outputs.has_engineer_done }}" == "false" ]; then
                # Check prerequisites (parent Epic completion)
                # For simplicity, assuming prerequisites are met
                run_engineer="true"
                echo "â†’ Route to: Engineer (Implementation)"
              elif [ "${{ steps.issue.outputs.has_engineer_done }}" == "true" ]; then
                run_reviewer="true"
                echo "â†’ Route to: Reviewer (Code Review)"
              fi
              ;;
            
            type:bug|type:docs)
              if [ "${{ steps.issue.outputs.has_engineer_done }}" == "false" ]; then
                run_engineer="true"
                echo "â†’ Route to: Engineer (Fix/Document)"
              elif [ "${{ steps.issue.outputs.has_engineer_done }}" == "true" ]; then
                run_reviewer="true"
                echo "â†’ Route to: Reviewer (Verification)"
              fi
              ;;
            
            type:spike)
              if [ "${{ steps.issue.outputs.has_architect_done }}" == "false" ]; then
                run_architect="true"
                echo "â†’ Route to: Architect (Research)"
              else
                echo "â†’ Spike complete, no routing needed"
              fi
              ;;
            
            *)
              echo "âš ï¸ Unknown issue type: $type"
              ;;
          esac
          
          # Set outputs
          echo "run_pm=$run_pm" >> $GITHUB_OUTPUT
          echo "run_architect=$run_architect" >> $GITHUB_OUTPUT
          echo "run_ux=$run_ux" >> $GITHUB_OUTPUT
          echo "run_engineer=$run_engineer" >> $GITHUB_OUTPUT
          echo "run_reviewer=$run_reviewer" >> $GITHUB_OUTPUT
      
      - name: Trigger Agent Workflows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ inputs.issue_number }}"
          agents_triggered=()
          
          if [ "${{ steps.route.outputs.run_pm }}" == "true" ]; then
            echo "ðŸš€ Triggering: Product Manager"
            gh workflow run run-product-manager.yml -f issue_number=$issue_number
            agents_triggered+=("Product Manager")
          fi
          
          if [ "${{ steps.route.outputs.run_architect }}" == "true" ]; then
            echo "ðŸš€ Triggering: Architect"
            gh workflow run run-architect.yml -f issue_number=$issue_number
            agents_triggered+=("Architect")
          fi
          
          if [ "${{ steps.route.outputs.run_ux }}" == "true" ]; then
            echo "ðŸš€ Triggering: UX Designer"
            gh workflow run run-ux-designer.yml -f issue_number=$issue_number
            agents_triggered+=("UX Designer")
          fi
          
          if [ "${{ steps.route.outputs.run_engineer }}" == "true" ]; then
            echo "ðŸš€ Triggering: Engineer"
            gh workflow run run-engineer.yml -f issue_number=$issue_number
            agents_triggered+=("Engineer")
          fi
          
          if [ "${{ steps.route.outputs.run_reviewer }}" == "true" ]; then
            echo "ðŸš€ Triggering: Reviewer"
            gh workflow run run-reviewer.yml -f issue_number=$issue_number
            agents_triggered+=("Reviewer")
          fi
          
          if [ ${#agents_triggered[@]} -eq 0 ]; then
            echo "â„¹ï¸ No agent workflows to trigger"
            comment="ðŸ¤– **Orchestrator**: No routing needed at this time.\n\nIssue state appears complete or blocked."
          else
            agents_list=$(IFS=', '; echo "${agents_triggered[*]}")
            comment="ðŸ¤– **Orchestrator**: Routing Complete\n\n"
            comment+="**Agents Triggered**: $agents_list\n"
            comment+="**Command**: \`${{ inputs.command }}\`\n\n"
            comment+="Workflows have been dispatched. Check Actions tab for progress."
          fi
          
          # Post comment
          gh issue comment $issue_number --body "$comment"
          
          echo "âœ… Orchestration complete"
      
      - name: Report Summary
        run: |
          echo "## Orchestration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ inputs.issue_number }} - ${{ steps.issue.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: ${{ steps.issue.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Command**: ${{ inputs.command }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agents Routed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Product Manager: ${{ steps.route.outputs.run_pm }}" >> $GITHUB_STEP_SUMMARY
          echo "- Architect: ${{ steps.route.outputs.run_architect }}" >> $GITHUB_STEP_SUMMARY
          echo "- UX Designer: ${{ steps.route.outputs.run_ux }}" >> $GITHUB_STEP_SUMMARY
          echo "- Engineer: ${{ steps.route.outputs.run_engineer }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reviewer: ${{ steps.route.outputs.run_reviewer }}" >> $GITHUB_STEP_SUMMARY
