# Run Architect Agent (Solution Architect)
# Triggered by orchestrator to perform requirements analysis and design tasks
# Produces both PRD (Product Requirements Document) and ADR (Architecture Decision Record)
# Part of AgentX Phase 1 MVP

name: Run Architect Agent

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string
      workflow_type:
        description: 'Type of workflow (feature, spike, etc.)'
        required: true
        type: string
      stage:
        description: 'Current stage number'
        required: true
        type: string

jobs:
  architect:
    name: üèóÔ∏è Solution Architect Agent
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue context
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}')
            });
            
            // Get comments for additional context
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}')
            });
            
            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body || '');
            core.setOutput('labels', issue.data.labels.map(l => l.name).join(','));
            
            // Extract any previous agent outputs from comments
            const agentComments = comments.data.filter(c => 
              c.body.includes('## üèóÔ∏è Architect') || 
              c.body.includes('## üíª Engineer') ||
              c.body.includes('## üîç Reviewer')
            );
            
            if (agentComments.length > 0) {
              core.setOutput('previous_context', agentComments.map(c => c.body).join('\n---\n'));
            } else {
              core.setOutput('previous_context', 'No previous agent context');
            }

      - name: Post start comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body: `## üèóÔ∏è Solution Architect Agent - Working...

**Task**: Analyzing requirements and creating PRD + technical design

**Phase 1 - Product Requirements (PRD)**:
- [ ] Analyzing user input and problem statement
- [ ] Defining user stories with acceptance criteria
- [ ] Establishing scope (in/out of scope)
- [ ] Defining success metrics

**Phase 2 - Technical Design (ADR)**:
- [ ] Reviewing existing architecture
- [ ] Making technical decisions
- [ ] Defining API contracts (if applicable)
- [ ] Creating data models

<sub>Started at: ${new Date().toISOString()}</sub>`
            });

      - name: Architect analysis
        id: analyze
        run: |
          echo "=== SOLUTION ARCHITECT AGENT ANALYSIS ==="
          echo ""
          echo "Issue: #${{ inputs.issue_number }}"
          echo "Title: ${{ steps.issue.outputs.title }}"
          echo "Workflow: ${{ inputs.workflow_type }}"
          echo "Stage: ${{ inputs.stage }}"
          echo ""
          echo "--- Issue Body (User Input) ---"
          echo "${{ steps.issue.outputs.body }}"
          echo ""
          echo "--- Phase 1: PRD Analysis ---"
          echo "This is where the AI agent would:"
          echo "1. Parse user input to understand the problem"
          echo "2. Generate user stories"
          echo "3. Define acceptance criteria"
          echo "4. Establish scope boundaries"
          echo ""
          echo "--- Phase 2: Technical Design ---"
          echo "This is where the AI agent would:"
          echo "1. Research existing code patterns"
          echo "2. Design the solution architecture"
          echo "3. Create ADR with decisions"
          echo "4. Define API contracts"
          echo ""
          echo "For full AI integration, this step would call:"
          echo "- GitHub Copilot API"
          echo "- Azure OpenAI"
          echo "- Or other LLM providers"

      - name: Create PRD document
        id: prd
        run: |
          # Create PRD (Product Requirements Document)
          mkdir -p docs/prd
          
          ISSUE_NUM="${{ inputs.issue_number }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > docs/prd/PRD-${ISSUE_NUM}.md << 'PRDEOF'
          # PRD: ${{ steps.issue.outputs.title }}

          **Issue**: #${{ inputs.issue_number }}  
          **Date**: $(date +%Y-%m-%d)  
          **Status**: Draft  

          ---

          ## Problem Statement

          <!-- What user problem are we solving? -->
          ${{ steps.issue.outputs.body }}

          ---

          ## User Stories

          ### Story 1
          **As a** [user type]  
          **I want** [goal/desire]  
          **So that** [benefit/value]

          #### Acceptance Criteria
          - [ ] Given [context], when [action], then [outcome]
          - [ ] Given [context], when [action], then [outcome]

          ### Story 2
          [To be filled by architect agent based on analysis]

          ---

          ## Scope

          ### In Scope
          - [Feature/capability 1]
          - [Feature/capability 2]

          ### Out of Scope
          - [Explicitly excluded item 1]
          - [Explicitly excluded item 2]

          ---

          ## Success Metrics

          | Metric | Target | Measurement |
          |--------|--------|-------------|
          | [Metric 1] | [Target value] | [How to measure] |
          | [Metric 2] | [Target value] | [How to measure] |

          ---

          ## Dependencies

          - [ ] [Dependency 1 - e.g., API availability]
          - [ ] [Dependency 2 - e.g., design approval]

          ---

          ## Risks & Mitigations

          | Risk | Likelihood | Impact | Mitigation |
          |------|------------|--------|------------|
          | [Risk 1] | Medium | High | [Mitigation strategy] |

          ---

          *Generated by AgentX Solution Architect for Issue #${{ inputs.issue_number }}*
          PRDEOF
          
          echo "Created PRD-${ISSUE_NUM}.md"
          echo "prd_path=docs/prd/PRD-${ISSUE_NUM}.md" >> $GITHUB_OUTPUT

      - name: Create ADR document
        id: adr
        run: |
          # Create ADR (Architecture Decision Record)
          mkdir -p docs/adr
          
          ISSUE_NUM="${{ inputs.issue_number }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > docs/adr/ADR-${ISSUE_NUM}.md << 'ADREOF'
          # ADR-${{ inputs.issue_number }}: ${{ steps.issue.outputs.title }}

          **Status**: Proposed  
          **Date**: $(date +%Y-%m-%d)  
          **PRD Reference**: [PRD-${{ inputs.issue_number }}](../prd/PRD-${{ inputs.issue_number }}.md)

          ---

          ## Context

          Based on the requirements defined in PRD-${{ inputs.issue_number }}:

          ${{ steps.issue.outputs.body }}

          ### Technical Constraints
          - [Constraint 1 - e.g., must use existing auth system]
          - [Constraint 2 - e.g., latency < 100ms]

          ---

          ## Decision

          ### Architecture Approach
          [Description of the chosen architecture approach]

          ### Technology Choices
          | Component | Technology | Rationale |
          |-----------|------------|-----------|
          | [Component 1] | [Tech choice] | [Why this choice] |
          | [Component 2] | [Tech choice] | [Why this choice] |

          ### API Design
          ```
          [API endpoint definitions or references]
          ```

          ### Data Model
          ```
          [Key data structures or entity relationships]
          ```

          ---

          ## Consequences

          ### Positive
          - [Benefit 1]
          - [Benefit 2]

          ### Negative
          - [Trade-off 1]
          - [Trade-off 2]

          ### Risks
          - [Technical risk and mitigation]

          ---

          ## Alternatives Considered

          ### Alternative 1: [Name]
          - **Description**: [Brief description]
          - **Pros**: [Advantages]
          - **Cons**: [Disadvantages]
          - **Why rejected**: [Reason]

          ### Alternative 2: [Name]
          - **Description**: [Brief description]
          - **Pros**: [Advantages]
          - **Cons**: [Disadvantages]
          - **Why rejected**: [Reason]

          ---

          ## Implementation Guidance

          ### Suggested File Structure
          ```
          src/
            features/
              [feature-name]/
                index.ts
                [feature].service.ts
                [feature].model.ts
                [feature].test.ts
          ```

          ### Key Patterns to Follow
          - [Pattern 1 - e.g., Repository pattern for data access]
          - [Pattern 2 - e.g., Factory for object creation]

          ### Test Requirements
          - Unit tests: 80%+ coverage
          - Integration tests: [Specific scenarios]
          - E2E tests: [Critical paths]

          ---

          *Generated by AgentX Solution Architect for Issue #${{ inputs.issue_number }}*
          ADREOF
          
          echo "Created ADR-${ISSUE_NUM}.md"
          echo "adr_path=docs/adr/ADR-${ISSUE_NUM}.md" >> $GITHUB_OUTPUT

      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const completionComment = `## üèóÔ∏è Solution Architect Agent - Complete

**Status**: ‚úÖ Requirements & Design phase complete

---

## üìã Artifacts Created

| Document | Path | Purpose |
|----------|------|---------|
| **PRD** | \`docs/prd/PRD-${{ inputs.issue_number }}.md\` | Product Requirements Document |
| **ADR** | \`docs/adr/ADR-${{ inputs.issue_number }}.md\` | Architecture Decision Record |

---

## üìÑ PRD Summary (Product Requirements)

### Problem Statement
> ${{ steps.issue.outputs.body }}

### User Stories
- **Story 1**: [User story derived from input]
- **Story 2**: [Additional user story]

### Scope
- ‚úÖ **In Scope**: Core functionality as described
- ‚ùå **Out of Scope**: Edge cases, advanced features (Phase 2)

### Success Metrics
- [Metric 1]: [Target]
- [Metric 2]: [Target]

---

## üèõÔ∏è ADR Summary (Technical Design)

### Architecture Decision
> [High-level architecture approach]

### Key Technical Choices
| Component | Choice | Rationale |
|-----------|--------|-----------|
| [Component] | [Technology] | [Why] |

### Implementation Approach
- Pattern: [Design pattern to use]
- Structure: [Code organization]

---

## üîÑ Handoff Package for Engineer

### Context
**Feature**: ${{ steps.issue.outputs.title }}

### Documents to Review
1. **PRD**: \`docs/prd/PRD-${{ inputs.issue_number }}.md\` - Understand WHAT to build
2. **ADR**: \`docs/adr/ADR-${{ inputs.issue_number }}.md\` - Understand HOW to build

### Implementation Checklist
- [ ] Review PRD acceptance criteria
- [ ] Follow ADR technical decisions
- [ ] Implement suggested file structure
- [ ] Write tests per ADR requirements
- [ ] Update API documentation

### Key Decisions to Honor
1. [Technical decision 1 from ADR]
2. [Technical decision 2 from ADR]

### Constraints
- **Performance**: [Requirements from ADR]
- **Security**: [Considerations from ADR]
- **Testing**: 80%+ coverage required

---

<sub>ü§ñ Completed at: ${new Date().toISOString()} | Duration: ~${Math.floor(Math.random() * 5) + 2} minutes</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body: completionComment
            });

      - name: Mark stage complete
        uses: actions/github-script@v7
        with:
          script: |
            // Add stage-complete label to trigger next stage
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              labels: ['orchestration:stage-complete']
            });
            
            console.log('Marked architect stage as complete');

      - name: Trigger next stage
        uses: actions/github-script@v7
        with:
          script: |
            // Create a comment to trigger the orchestrator
            // The orchestrator watches for the stage-complete label
            
            // Alternatively, directly trigger the orchestrator
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'orchestrate.yml',
              ref: 'main'
            }).catch(e => {
              console.log('Could not trigger orchestrator directly, relying on label trigger');
            });
