name: Sync Project Status to Labels

on:
  issues:
    types: [opened, reopened]
  project_v2_item:
    types: [edited]

jobs:
  sync-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Sync Status Field to Label
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue?.number || 
                                context.payload.project_v2_item?.content_node_id;
            
            if (!issue_number) {
              console.log('â¸ï¸  No issue number found');
              return;
            }
            
            console.log(`ðŸ”„ Syncing status for issue #${issue_number}`);
            
            // Get project Status field value via GraphQL
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    projectItems(first: 1) {
                      nodes {
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number)
            });
            
            // Find Status field
            let statusValue = null;
            for (const item of result.repository.issue.projectItems.nodes) {
              for (const fieldValue of item.fieldValues.nodes) {
                if (fieldValue.field?.name === 'Status') {
                  statusValue = fieldValue.name;
                  break;
                }
              }
              if (statusValue) break;
            }
            
            console.log(`Found status: ${statusValue}`);
            core.setOutput('status', statusValue);
            core.setOutput('issue_number', issue_number);

      - name: Map Status to Label
        id: map-label
        run: |
          STATUS="${{ steps.get-status.outputs.status }}"
          
          # Map Project Status values to label names
          case "$STATUS" in
            "Backlog"|"ðŸ“ Backlog")
              echo "label=status:ready" >> $GITHUB_OUTPUT
              ;;
            "Planning"|"ðŸ“‹ Planning")
              echo "label=status:planning" >> $GITHUB_OUTPUT
              ;;
            "Designing"|"ðŸ—ï¸ Designing")
              echo "label=status:designing" >> $GITHUB_OUTPUT
              ;;
            "Implementing"|"ðŸ’» Implementing")
              echo "label=status:implementing" >> $GITHUB_OUTPUT
              ;;
            "Reviewing"|"ðŸ” Reviewing")
              echo "label=status:reviewing" >> $GITHUB_OUTPUT
              ;;
            "Done"|"âœ… Done")
              echo "label=status:done" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "No status mapping found for: $STATUS"
              exit 0
              ;;
          esac

      - name: Update Issue Labels
        if: steps.map-label.outputs.label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = ${{ steps.get-status.outputs.issue_number }};
            const newLabel = '${{ steps.map-label.outputs.label }}';
            
            // Get current labels
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            // Remove all existing status:* labels
            const currentLabels = issue.labels.map(l => l.name);
            const statusLabels = currentLabels.filter(l => l.startsWith('status:'));
            
            for (const label of statusLabels) {
              if (label !== newLabel) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  name: label
                });
              }
            }
            
            // Add new status label if not already present
            if (!currentLabels.includes(newLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                labels: [newLabel]
              });
            }
            
            console.log(`âœ… Synced status to label: ${newLabel}`);
